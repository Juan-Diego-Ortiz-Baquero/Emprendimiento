/*=============== AGROTRACE DASHBOARD JAVASCRIPT ===============*/

// ===== GLOBAL STATE =====
const AppState = {
    currentView: 'dashboard',
    dashboardData: {},
    charts: {},
    animalsData: [],
    currentPage: 1,
    itemsPerPage: 15,
    filters: {
        search: '',
        status: 'all',
        breed: 'all'
    }
};

// ===== DOM ELEMENTS =====
const DOM = {
    loadingScreen: null,
    sidebar: null,
    sidebarToggle: null,
    navLinks: null,
    views: null,
    pageTitle: null,
    
    init() {
        this.loadingScreen = document.getElementById('loading-screen');
        this.sidebar = document.getElementById('sidebar');
        this.sidebarToggle = document.getElementById('sidebar-toggle');
        this.navLinks = document.querySelectorAll('.nav-link');
        this.views = document.querySelectorAll('.content-view');
        this.pageTitle = document.getElementById('page-title');
    }
};

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
});

async function initializeApp() {
    try {
        // Initialize DOM references
        DOM.init();
        
        // Show loading screen
        showLoadingScreen();
        
        // Simulate system initialization
        await simulateSystemInit();
        
        // Load initial data
        await loadDashboardData();
        
        // Initialize UI components
        initializeSidebar();
        initializeNavigation();
        initializeCharts();
        initializeSearch();
        initializeRealTime();
        
        // Hide loading screen and show dashboard
        hideLoadingScreen();
        showView('dashboard');
        
        console.log('‚úì AgroTrace System initialized successfully');
    } catch (error) {
        console.error('‚úó Error initializing app:', error);
        showNotification('Error al inicializar el sistema', 'error');
    }
}

// ===== LOADING SCREEN =====
function showLoadingScreen() {
    if (DOM.loadingScreen) {
        DOM.loadingScreen.classList.remove('hidden');
    }
}

function hideLoadingScreen() {
    if (DOM.loadingScreen) {
        setTimeout(() => {
            DOM.loadingScreen.classList.add('hidden');
        }, 1500);
    }
}

async function simulateSystemInit() {
    const steps = [
        'Iniciando sistema RFID...',
        'Conectando con base de datos...',
        'Sincronizando dispositivos...',
        'Cargando datos del ganado...'
    ];
    
    const loadingText = document.querySelector('.loading-text p');
    
    for (let i = 0; i < steps.length; i++) {
        if (loadingText) {
            loadingText.textContent = steps[i];
        }
        await new Promise(resolve => setTimeout(resolve, 400));
    }
}

// ===== SIDEBAR FUNCTIONALITY =====
function initializeSidebar() {
    if (DOM.sidebarToggle) {
        DOM.sidebarToggle.addEventListener('click', toggleSidebar);
    }
    
    // Handle mobile responsiveness
    handleResponsiveSidebar();
    window.addEventListener('resize', handleResponsiveSidebar);
}

function toggleSidebar() {
    if (DOM.sidebar) {
        DOM.sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', DOM.sidebar.classList.contains('collapsed'));
    }
}

function handleResponsiveSidebar() {
    const width = window.innerWidth;
    if (width <= 768 && DOM.sidebar) {
        DOM.sidebar.classList.add('mobile');
        if (!DOM.sidebar.classList.contains('open')) {
            DOM.sidebar.style.transform = 'translateX(-100%)';
        }
    } else if (DOM.sidebar) {
        DOM.sidebar.classList.remove('mobile');
        DOM.sidebar.style.transform = '';
    }
}

// ===== NAVIGATION =====
function initializeNavigation() {
    DOM.navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const viewName = link.getAttribute('data-view');
            if (viewName) {
                showView(viewName);
                setActiveNavLink(link);
                
                // Close sidebar on mobile after navigation
                if (window.innerWidth <= 768 && DOM.sidebar) {
                    DOM.sidebar.classList.remove('open');
                }
            }
        });
    });
}

function showView(viewName) {
    // Hide all views
    DOM.views.forEach(view => {
        view.classList.remove('active');
    });
    
    // Show selected view
    const targetView = document.getElementById(`${viewName}-view`);
    if (targetView) {
        targetView.classList.add('active');
        AppState.currentView = viewName;
        
        // Update page title
        updatePageTitle(viewName);
        
        // Load view-specific data
        loadViewData(viewName);
    }
}

function setActiveNavLink(activeLink) {
    DOM.navLinks.forEach(link => {
        link.classList.remove('active');
    });
    activeLink.classList.add('active');
}

function updatePageTitle(viewName) {
    const viewTitles = {
        'dashboard': 'Dashboard',
        'animals': 'Gesti√≥n de Animales',
        'health': 'Monitoreo de Salud',
        'traceability': 'Trazabilidad',
        'reports': 'Reportes y An√°lisis',
        'activity': 'Log de Actividad',
        'settings': 'Configuraci√≥n del Sistema'
    };
    
    if (DOM.pageTitle) {
        DOM.pageTitle.textContent = viewTitles[viewName] || 'Dashboard';
    }
}

// ===== DATA LOADING =====
async function loadDashboardData() {
    try {
        const response = await fetch('/api/dashboard-stats');
        if (response.ok) {
            const data = await response.json();
            AppState.dashboardData = data;
            updateDashboardStats(data);
            await loadActivityFeed();
        }
    } catch (error) {
        console.warn('‚ö† Using simulated data:', error.message);
        AppState.dashboardData = getSimulatedData();
        updateDashboardStats(AppState.dashboardData);
        updateActivityFeed(AppState.dashboardData.activity);
    }
}

async function loadActivityFeed() {
    try {
        const response = await fetch('/api/activity-feed');
        if (response.ok) {
            const activities = await response.json();
            updateActivityFeed(activities);
        }
    } catch (error) {
        console.warn('‚ö† Using simulated activity data');
        updateActivityFeed(getSimulatedData().activity);
    }
}

async function loadViewData(viewName) {
    switch (viewName) {
        case 'animals':
            await loadAnimalsData();
            break;
        case 'health':
            await loadHealthData();
            break;
        case 'traceability':
        case 'reports':
        case 'activity':
        case 'settings':
            // Views en desarrollo
            console.log(`üìã Vista ${viewName} en desarrollo`);
            break;
        default:
            break;
    }
}

// ===== DASHBOARD STATS =====
function updateDashboardStats(data) {
    if (!data) return;
    
    const stats = data.stats || data;
    
    // Update stat cards with animation
    updateStatCard('total-animals', stats.total_animals || 155);
    updateStatCard('healthy-animals', stats.healthy_animals || 142);
    updateStatCard('alerts', stats.active_alerts || 3);
    
    // Update other dashboard elements
    const elements = {
        'vaccination-rate': (stats.vaccination_rate || 94.2) + '%',
        'system-time': new Date().toLocaleTimeString('es-ES')
    };
    
    Object.entries(elements).forEach(([id, value]) => {
        const elem = document.getElementById(id);
        if (elem) elem.textContent = value;
    });
}

function updateStatCard(cardId, value) {
    const valueElement = document.getElementById(cardId);
    if (!valueElement) return;
    
    const currentValue = parseInt(valueElement.textContent) || 0;
    if (currentValue !== value) {
        animateNumber(valueElement, currentValue, value);
    }
}

function animateNumber(element, from, to) {
    const duration = 1000;
    const steps = 20;
    const increment = (to - from) / steps;
    let current = from;
    let step = 0;
    
    const timer = setInterval(() => {
        current += increment;
        element.textContent = Math.round(current);
        step++;
        
        if (step >= steps) {
            element.textContent = to;
            clearInterval(timer);
        }
    }, duration / steps);
}

// ===== ACTIVITY FEED =====
function updateActivityFeed(activities) {
    const activityList = document.querySelector('.activity-list');
    if (!activityList || !activities || !Array.isArray(activities)) {
        console.warn('‚ö† No activity list container or invalid data');
        return;
    }
    
    activityList.innerHTML = '';
    
    activities.slice(0, 10).forEach(activity => {
        const activityItem = createActivityItem(activity);
        activityList.appendChild(activityItem);
    });
}

function createActivityItem(activity) {
    const item = document.createElement('li');
    item.className = 'activity-item';
    
    const iconClass = getActivityIconClass(activity.type);
    const description = activity.description || activity.message || 'Actividad del sistema';
    const timestamp = activity.timestamp || new Date();
    
    item.innerHTML = `
        <div class="activity-icon ${activity.type}">
            <i class="${iconClass}"></i>
        </div>
        <div class="activity-content">
            <div class="activity-text">${description}</div>
            <div class="activity-time">${formatTimeAgo(timestamp)}</div>
        </div>
    `;
    
    return item;
}

function getActivityIconClass(type) {
    const iconMap = {
        'scan': 'fas fa-wifi',
        'health': 'fas fa-heart-pulse',
        'movement': 'fas fa-location-dot',
        'alert': 'fas fa-exclamation-triangle',
        'vaccination': 'fas fa-syringe',
        'info': 'fas fa-info-circle'
    };
    return iconMap[type] || 'fas fa-circle';
}

function formatTimeAgo(timestamp) {
    const now = new Date();
    const time = typeof timestamp === 'string' ? new Date(timestamp) : timestamp;
    const diffInMinutes = Math.floor((now - time) / (1000 * 60));
    
    if (diffInMinutes < 1) return 'Ahora mismo';
    if (diffInMinutes < 60) return `Hace ${diffInMinutes}min`;
    if (diffInMinutes < 1440) return `Hace ${Math.floor(diffInMinutes / 60)}h`;
    return `Hace ${Math.floor(diffInMinutes / 1440)}d`;
}

// ===== CHARTS =====
function initializeCharts() {
    // Wait for DOM to be ready
    setTimeout(() => {
        initializeActivityChart();
    }, 800);
}

function initializeActivityChart() {
    const canvas = document.getElementById('activity-chart');
    if (!canvas) {
        console.warn('‚ö† Activity chart canvas not found');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Destroy existing chart if it exists
    if (AppState.charts.activity) {
        AppState.charts.activity.destroy();
    }
    
    AppState.charts.activity = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
            datasets: [{
                label: 'Lecturas RFID',
                data: [120, 150, 180, 140, 200, 160, 190],
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: 'rgb(16, 185, 129)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    borderColor: 'rgba(16, 185, 129, 0.5)',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        font: {
                            size: 12
                        },
                        color: '#64748b'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 12
                        },
                        color: '#64748b'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// ===== ANIMALS DATA =====
async function loadAnimalsData() {
    try {
        const params = new URLSearchParams({
            page: AppState.currentPage,
            per_page: AppState.itemsPerPage,
            search: AppState.filters.search
        });
        
        const response = await fetch(`/api/animals?${params}`);
        if (response.ok) {
            const data = await response.json();
            AppState.animalsData = data.animals;
            updateAnimalsTable(data.animals);
            updatePagination(data.page, data.pages, data.total);
        }
    } catch (error) {
        console.warn('‚ö† Using simulated animals data:', error.message);
        const simulated = getSimulatedAnimals();
        AppState.animalsData = simulated;
        updateAnimalsTable(simulated);
    }
}

function updateAnimalsTable(animals) {
    const tableBody = document.querySelector('#animals-tbody');
    if (!tableBody) {
        console.warn('‚ö† Animals table body not found');
        return;
    }
    
    if (!animals || animals.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:2rem;color:var(--text-muted);">No se encontraron animales</td></tr>';
        return;
    }
    
    tableBody.innerHTML = '';
    
    animals.forEach(animal => {
        const row = createAnimalRow(animal);
        tableBody.appendChild(row);
    });
}

function createAnimalRow(animal) {
    const row = document.createElement('tr');
    row.style.cursor = 'pointer';
    row.addEventListener('click', () => viewAnimalDetails(animal));
    
    const statusClass = (animal.status?.class || animal.health_status || 'healthy').toLowerCase().replace(/\s+/g, '-');
    const statusText = animal.status?.name || animal.health_status || 'Saludable';
    const rfid = animal.rfid || animal.rfid_id || 'N/A';
    const name = animal.name || 'Sin nombre';
    const breed = animal.breed || 'N/A';
    const age = animal.age_months ? `${animal.age_months} meses` : 'N/A';
    const location = animal.location || 'N/A';
    const lastScan = animal.last_scan ? formatDateTime(animal.last_scan) : 'N/A';
    
    row.innerHTML = `
        <td><input type="checkbox" onclick="event.stopPropagation()"></td>
        <td><strong style="font-family: var(--font-mono); font-size: 0.85rem;">${rfid}</strong></td>
        <td>${name}</td>
        <td>${breed}</td>
        <td>${age}</td>
        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
        <td>${lastScan}</td>
        <td>${location}</td>
        <td>
            <button class="btn-link" onclick="event.stopPropagation(); viewAnimalDetails(${JSON.stringify(animal).replace(/"/g, '&quot;')})" title="Ver detalles">
                <i class="fas fa-eye"></i>
            </button>
        </td>
    `;
    
    return row;
}

function updatePagination(currentPage, totalPages, totalRecords) {
    const start = (currentPage - 1) * AppState.itemsPerPage + 1;
    const end = Math.min(currentPage * AppState.itemsPerPage, totalRecords);
    
    const startElem = document.getElementById('showing-start');
    const endElem = document.getElementById('showing-end');
    const totalElem = document.getElementById('total-records');
    
    if (startElem) startElem.textContent = start;
    if (endElem) endElem.textContent = end;
    if (totalElem) totalElem.textContent = totalRecords;
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;
    
    return date.toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// ===== REAL-TIME UPDATES =====
function initializeRealTime() {
    // Update time display every second
    updateSystemTime();
    setInterval(updateSystemTime, 1000);
    
    // Update dashboard data every 30 seconds
    setInterval(async () => {
        if (AppState.currentView === 'dashboard') {
            await loadDashboardData();
        }
    }, 30000);
    
    // Simulate periodic sync indicator
    setInterval(updateSyncIndicator, 5000);
}

function updateSystemTime() {
    const timeElem = document.getElementById('system-time');
    if (timeElem) {
        timeElem.textContent = new Date().toLocaleTimeString('es-ES');
    }
}

function updateSyncIndicator() {
    const syncElem = document.getElementById('sync-time');
    if (syncElem) {
        syncElem.textContent = 'Sincronizado hace ' + Math.floor(Math.random() * 10) + 's';
    }
}

// ===== UTILITY FUNCTIONS =====
function animateNumber(element, from, to) {
    const duration = 800;
    const steps = 30;
    const increment = (to - from) / steps;
    let current = from;
    let step = 0;
    
    const timer = setInterval(() => {
        current += increment;
        element.textContent = Math.round(current);
        step++;
        
        if (step >= steps) {
            element.textContent = to;
            clearInterval(timer);
        }
    }, duration / steps);
}

function getSimulatedData() {
    return {
        stats: {
            total_animals: 155,
            healthy_animals: 142,
            health_percentage: 91.6,
            recent_scans: 89,
            active_alerts: 3,
            vaccination_rate: 94.2,
            avg_health_score: 87.5,
            system_uptime: '99.8%',
            last_sync: new Date().toLocaleTimeString('es-ES')
        },
        activity: [
            {
                type: 'scan',
                description: 'Animal RFID_8A7B2F3C escaneado en Sector A',
                message: 'Animal RFID_8A7B2F3C escaneado en Sector A',
                timestamp: new Date(Date.now() - 3 * 60000)
            },
            {
                type: 'vaccination',
                description: 'Vacunaci√≥n completada para Animal-045',
                message: 'Vacunaci√≥n completada para Animal-045',
                timestamp: new Date(Date.now() - 12 * 60000)
            },
            {
                type: 'movement',
                description: 'Traslado de 15 animales a Pastoreo Norte',
                message: 'Traslado de 15 animales a Pastoreo Norte',
                timestamp: new Date(Date.now() - 28 * 60000)
            },
            {
                type: 'health',
                description: 'Chequeo veterinario programado para ma√±ana',
                message: 'Chequeo veterinario programado para ma√±ana',
                timestamp: new Date(Date.now() - 45 * 60000)
            },
            {
                type: 'alert',
                description: 'Alerta: Animal AG0023 requiere atenci√≥n veterinaria',
                message: 'Alerta: Animal AG0023 requiere atenci√≥n veterinaria',
                timestamp: new Date(Date.now() - 67 * 60000)
            }
        ]
    };
}

function getSimulatedAnimals() {
    const animals = [];
    const breeds = ['Holstein', 'Brahman', 'Angus', 'Simmental', 'Charolais'];
    const statuses = [
        { name: 'Saludable', class: 'healthy' },
        { name: 'En Observaci√≥n', class: 'warning' },
        { name: 'Tratamiento', class: 'critical' }
    ];
    const locations = ['Sector A', 'Sector B', 'Sector C', 'Corral 1', 'Corral 2', 'Pastoreo Norte'];
    
    for (let i = 1; i <= 25; i++) {
        animals.push({
            id: `AG${String(i).padStart(4, '0')}`,
            rfid: `RFID_${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
            rfid_id: `RFID_${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
            name: `Animal-${String(i).padStart(3, '0')}`,
            breed: breeds[Math.floor(Math.random() * breeds.length)],
            age_months: Math.floor(Math.random() * 60) + 12,
            weight: Math.floor(Math.random() * 400) + 250,
            status: statuses[Math.floor(Math.random() * statuses.length)],
            health_status: statuses[Math.floor(Math.random() * statuses.length)].name,
            location: locations[Math.floor(Math.random() * locations.length)],
            last_scan: new Date(Date.now() - Math.random() * 48 * 60 * 60 * 1000),
            health_score: Math.floor(Math.random() * 30) + 70
        });
    }
    
    return animals;
}

// ===== INITIALIZATION CHECK =====
console.log('%c‚úì AgroTrace Dashboard System', 'color: #10b981; font-size: 14px; font-weight: bold;');
console.log('%cVersion 2.1.4 - Build 2025.11.11', 'color: #64748b; font-size: 12px;');
console.log('%cDeveloped by Santiago Valenzuela & Juan Ortiz', 'color: #64748b; font-size: 11px;');


// ===== SEARCH FUNCTIONALITY =====
function initializeSearch() {
    // Global search in top bar
    const globalSearch = document.querySelector('.global-search');
    if (globalSearch) {
        globalSearch.addEventListener('input', debounce(handleGlobalSearch, 300));
    }
    
    // Animals search
    const animalsSearch = document.getElementById('animals-search');
    if (animalsSearch) {
        animalsSearch.addEventListener('input', debounce(handleAnimalsSearch, 300));
    }
}

function handleGlobalSearch(e) {
    const query = e.target.value.trim().toLowerCase();
    console.log('üîç Global search:', query);
    
    if (query.length < 2) return;
    
    // Implement global search across all views
    // For now, log the query
    showNotification(`Buscando: ${query}`, 'info');
}

function handleAnimalsSearch(e) {
    const query = e.target.value.trim();
    AppState.filters.search = query;
    AppState.currentPage = 1;
    loadAnimalsData();
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ===== HEALTH DATA =====
async function loadHealthData() {
    console.log('üìä Loading health data...');
    
    // Update health statistics
    const stats = AppState.dashboardData.stats || AppState.dashboardData;
    
    const vaccinationRate = document.getElementById('vaccination-rate');
    if (vaccinationRate && stats.vaccination_rate) {
        vaccinationRate.textContent = stats.vaccination_rate + '%';
    }
    
    const activeTreatments = document.getElementById('active-treatments');
    if (activeTreatments) {
        activeTreatments.textContent = Math.floor(Math.random() * 15) + 5;
    }
    
    const quarantined = document.getElementById('quarantined');
    if (quarantined && stats.active_alerts) {
        quarantined.textContent = stats.active_alerts;
    }
}

// ===== ACTION HANDLERS =====
function viewAnimalDetails(animal) {
    const animalData = typeof animal === 'string' ? { rfid: animal } : animal;
    
    console.log('üëÅ Viewing animal details:', animalData);
    
    const rfid = animalData.rfid || animalData.rfid_id || 'Desconocido';
    const name = animalData.name || 'Sin nombre';
    const breed = animalData.breed || 'N/A';
    const status = animalData.status?.name || animalData.health_status || 'N/A';
    
    showNotification(`Detalles: ${name} (${rfid})`, 'info');
    
    // In a real app, this would open a modal or navigate to detail view
    alert(`üìã Detalles del Animal\n\nID RFID: ${rfid}\nNombre: ${name}\nRaza: ${breed}\nEstado: ${status}\n\n‚ú® Funcionalidad completa disponible en versi√≥n Pro`);
}

function handleQuickAction(action) {
    console.log('‚ö° Quick action:', action);
    
    const actions = {
        'nuevo-animal': '‚ûï Registrar nuevo animal',
        'escanear-rfid': 'üì° Iniciar escaneo RFID',
        'registro-salud': 'üíâ Registro sanitario',
        'generar-reporte': 'üìä Generar reporte'
    };
    
    const actionName = actions[action] || action;
    showNotification(actionName, 'info');
}

// ===== NOTIFICATIONS =====
function showNotification(message, type = 'info') {
    const toast = document.getElementById('notification-toast');
    if (!toast) {
        // Create inline notification if toast doesn't exist
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 10000;
            font-size: 14px;
            max-width: 350px;
            font-weight: 500;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 4000);
        return;
    }
    
    const toastTitle = toast.querySelector('.toast-title');
    const toastMessage = toast.querySelector('.toast-message');
    const toastIcon = toast.querySelector('.toast-icon i');
    
    if (toastTitle) toastTitle.textContent = type === 'success' ? '‚úì √âxito' : type === 'error' ? '‚úó Error' : '‚Ñπ Informaci√≥n';
    if (toastMessage) toastMessage.textContent = message;
    if (toastIcon) {
        toastIcon.className = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-times-circle' : 'fas fa-info-circle';
    }
    
    toast.classList.add('show');
    
    setTimeout(() => toast.classList.remove('show'), 5000);
}

// Close toast on button click
document.addEventListener('click', (e) => {
    if (e.target.closest('.toast-close')) {
        const toast = document.getElementById('notification-toast');
        if (toast) toast.classList.remove('show');
    }
});

// ===== RESPONSIVE HANDLERS =====
window.addEventListener('resize', () => {
    handleResponsiveSidebar();
    
    // Resize charts
    Object.values(AppState.charts).forEach(chart => {
        if (chart && typeof chart.resize === 'function') {
            chart.resize();
        }
    });
});
